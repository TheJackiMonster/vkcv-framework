#version 460
#extension GL_ARB_separate_shader_objects   : enable
#extension GL_NV_mesh_shader                : require

layout(local_size_x=32) in;

layout(triangles) out;
layout(max_vertices=64, max_primitives=126) out;

layout( push_constant ) uniform constants{
    mat4 mvp;
};

layout(location = 0) out vec3 passNormal[];

struct Vertex
{
    vec3 position;
    vec3 normal;
};

layout(std430, binding = 0) readonly buffer vertexBuffer
{
    Vertex vertices[];
};

layout(std430, binding = 1) readonly buffer indexBuffer
{
    uint indices[]; // breaks for 16 bit indices
};

void main()	{
	if(gl_LocalInvocationID.x == 0)
	{
		gl_PrimitiveCountNV = 1;
		gl_PrimitiveIndicesNV[0] = 0;
		gl_PrimitiveIndicesNV[1] = 1;
		gl_PrimitiveIndicesNV[2] = 2;
		
		gl_MeshVerticesNV[0].gl_Position = mvp * vec4(-0.5,  0.5, 0.5, 1);
		gl_MeshVerticesNV[1].gl_Position = mvp * vec4( 0.5,  0.5, 0.5, 1);
		gl_MeshVerticesNV[2].gl_Position = mvp * vec4( 0  , -0.5, 0.5, 1);
		
		passNormal[0] = vec3(1, 0, 0);
		passNormal[1] = vec3(0, 1, 0);
		passNormal[2] = vec3(0, 0, 1);		
	}
}